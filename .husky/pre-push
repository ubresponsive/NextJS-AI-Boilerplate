echo "Running pre-push validation..."

# Run full production build test
echo "Testing production build..."
npm run build

# Check API health status
echo "Checking API health status..."
if command -v curl >/dev/null 2>&1; then
  npm run dev &
  DEV_PID=$!
  sleep 8
  
  # Test health check endpoint
  HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health-check || echo "000")
  
  # Stop development server
  kill $DEV_PID 2>/dev/null || true
  sleep 2
  
  if [ "$HEALTH_CHECK" = "200" ]; then
    echo "✅ All APIs are healthy"
  elif [ "$HEALTH_CHECK" = "503" ]; then
    echo "⚠️  Some APIs are degraded but deployment can proceed"
  else
    echo "❌ Health check failed (HTTP $HEALTH_CHECK)"
    echo "Run 'npm run dev' and visit http://localhost:3000/api/health-check for details"
    exit 1
  fi
else
  echo "⚠️  curl not available, skipping health check"
fi

echo "Pre-push validation completed! Ready for deployment."